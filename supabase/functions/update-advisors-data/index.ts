import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.50.0';

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// Complete advisors matrix based on the Excel data - using canonical names
const comprehensiveAdvisorsData = {
  required_categories: [
    'אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 
    'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע',
    'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש',
    'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי',
    'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי',
    'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים',
    'יועץ בטיחות בעבודה', 'יועץ מתח נמוך', 'יועץ חשמל חכם', 'יועץ תאורה',
    'יועץ מתקנים רובוטיים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה',
    'ניהול פרויקטים', 'יועץ מערכות אבטחה', 'חשב כמויות', 'עיצוב פנים',
    'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות',
    'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות',
    'ספק גז', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות',
    'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה',
    // New specializations
    'יועץ סביבתי', 'יועץ CFD', 'הסדרי תנועה', 'התארגנות אתר', 'פרסום תכנון ובניה'
  ],
  projects: [
    {
      Project: "פינוי־בינוי (מתחמים)",
      Category: "התחדשות עירונית",
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'יועץ בטיחות בעבודה', 'יועץ מתח נמוך', 'יועץ חשמל חכם', 'יועץ תאורה', 'יועץ מתקנים רובוטיים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות', 'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    },
    {
      Project: "תמ\"א 38/1 – חיזוק ותוספות",
      Category: "התחדשות עירונית",
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'יועץ בטיחות בעבודה', 'יועץ מתח נמוך', 'יועץ חשמל חכם', 'יועץ תאורה', 'יועץ מתקנים רובוטיים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות', 'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    },
    {
      Project: "תמ\"א 38/2 – הריסה ובנייה מחדש",
      Category: "התחדשות עירונית",
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'יועץ בטיחות בעבודה', 'יועץ מתח נמוך', 'יועץ חשמל חכם', 'יועץ תאורה', 'יועץ מתקנים רובוטיים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות', 'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    },
    {
      Project: "שינוי ייעוד / הפקדת תב\"ע",
      Category: "סטטוטוריקה ותכנון עירוני",
      Advisors: ['אדריכל', 'מודד מוסמך']
    },
    {
      Project: "איחוד וחלוקה / פרצלציה",
      Category: "סטטוטוריקה ותכנון עירוני",
      Advisors: ['אדריכל', 'מודד מוסמך']
    },
    {
      Project: "עבודה מול רמ\"י / משרד השיכון",
      Category: "סטטוטוריקה ותכנון עירוני",
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות', 'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    },
    {
      Project: "מתחמי מגורים משולבים",
      Category: "סטטוטוריקה ותכנון עירוני",
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ איטום', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'יועץ בטיחות בעבודה', 'יועץ מתח נמוך', 'יועץ חשמל חכם', 'יועץ תאורה', 'יועץ מתקנים רובוטיים', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'עיצוב לובאים', 'שינויי דיירים', 'ניהול מודל BIM', 'תיאום מערכות', 'ממדל רוויט', 'שרטט', 'יועץ אחזקה', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    },
    {
      Project: "צמודי קרקע / וילות",
      Category: "מגורים", 
      Advisors: ['אדריכל', 'עורך דין מקרקעין', 'יועץ אינסטלציה', 'יועץ מיזוג אוויר', 'יועץ כבישים תנועה וחניה', 'אדריכל נוף ופיתוח', 'יועץ חשמל', 'אגרונום', 'יועץ קרקע', 'מודד מוסמך', 'יועץ אקוסטיקה', 'יועץ בנייה ירוקה', 'יועץ בטיחות אש', 'יועץ קונסטרוקציה', 'יועץ נגישות', 'יועץ מיגון', 'יועץ מעליות', 'יועץ תרמי', 'יועץ הידרולוגיה', 'יועץ אלומיניום', 'יועץ תברואה', 'יועץ קרינה', 'מקדם רישוי', 'יועץ אנרגיה', 'סוקר אסבסט', 'יועץ גז', 'יועץ השפלת מים', 'יועץ מתח נמוך', 'יועץ תאורה', 'שמאי מקרקעין', 'יועץ מיסוי', 'מפקח בנייה', 'ניהול פרויקטים', 'חשב כמויות', 'עיצוב פנים', 'יועץ מערכות סולאריות', 'הדמיות', 'כלכלן ביצוע', 'בדיקת אל הרס', 'בדיקת אפיון רשת', 'מכון העתקות', 'משווק נדל"ן', 'מכון התעדה (בניה ירוקה)', 'מכון בקרה']
    }
  ]
};

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    console.log('Updating advisors data in storage...');

    // Upload the new comprehensive data to storage
    const jsonData = JSON.stringify(comprehensiveAdvisorsData, null, 2);
    const encoder = new TextEncoder();
    const dataBlob = encoder.encode(jsonData);

    const { error } = await supabaseClient.storage
      .from('json')
      .upload('advisors_projects_full.json', dataBlob, {
        contentType: 'application/json',
        upsert: true
      });

    if (error) {
      console.error('Storage error:', error);
      throw new Error(`Failed to update file: ${error.message}`);
    }

    console.log('Successfully updated advisors data');

    return new Response(JSON.stringify({ 
      success: true,
      message: 'Advisors data updated successfully',
      totalProjects: comprehensiveAdvisorsData.projects.length,
      totalAdvisorTypes: comprehensiveAdvisorsData.required_categories.length
    }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
    });

  } catch (error) {
    console.error('Error in update-advisors-data function:', error);
    return new Response(
      JSON.stringify({ 
        error: error.message
      }), 
      {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      }
    );
  }
});
